<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Yahnev Scorer</title>
<style>
  body {
    margin: 0;
    font-family: -apple-system, BlinkMacSystemFont, sans-serif;
    background: #fafafa;
    color: #222;
  }

  h1 {
    text-align: center;
    padding: 16px 0 0;
    margin: 0;
    font-size: 28px;
    font-weight: 700;
  }

  .section {
    padding: 16px;
  }

  input[type="text"], input[type="number"], select {
    padding: 10px;
    font-size: 18px;
    width: 100%;
    border-radius: 8px;
    border: 1px solid #ccc;
    margin-bottom: 12px;
  }

  button {
    width: 100%;
    padding: 14px;
    border-radius: 8px;
    border: none;
    font-size: 18px;
    background: #007aff;
    color: white;
    font-weight: bold;
    margin-top: 6px;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 12px;
  }

  th, td {
    padding: 12px;
    font-size: 18px;
    text-align: center;
  }

  .log-item {
    background: white;
    padding: 12px;
    border-radius: 8px;
    margin-bottom: 8px;
    font-size: 16px;
    border: 1px solid #ddd;
  }

  #log {
    max-height: 280px;
    overflow-y: auto;
  }

  .player-row {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 12px;
  }

  .player-row input[type="number"] {
    width: 90px;
  }

  .yahnev-radio {
    transform: scale(1.3);
  }

  .fire {
    font-size: 26px;
    animation: pop 0.4s ease;
  }

  @keyframes pop {
    0% { transform: scale(0.1); opacity: 0; }
    100% { transform: scale(1.2); opacity: 1; }
  }

</style>
</head>
<body>

<h1>Yahnev</h1>

<div class="section" id="players"></div>

<div class="section" id="addPlayerSection">
  <input id="newPlayer" type="text" placeholder="Name">
  <button onclick="addPlayer()">Add Player</button>
</div>

<div class="section">
  <h2>Add Round</h2>
  <div id="roundInputs"></div>
  <button onclick="addRound()">Submit Round</button>
  <button onclick="undo()">Undo</button>
</div>

<div class="section">
  <h2>Scores</h2>
  <table border="1">
    <thead>
      <tr>
        <th>Player</th>
        <th>Total</th>
        <th>Streak</th>
      </tr>
    </thead>
    <tbody id="scoreTable"></tbody>
  </table>
</div>

<div class="section">
  <h2>Log</h2>
  <div id="log"></div>
</div>

<script>
let players = [];
let rounds = [];
const ASSAF_PENALTY = 25;
const STREAK_PENALTY = -10;

function addPlayer() {
  const name = document.getElementById("newPlayer").value.trim();
  if (!name) return;
  players.push({ id: Date.now(), name, total: 0, streak: 0 });
  document.getElementById("newPlayer").value = "";
  render();
}

function addRound() {
  if (players.length === 0) return;

  let entries = [];
  let caller = null;

  players.forEach(p => {
    const raw = Number(document.getElementById("score_" + p.id).value || 0);
    entries.push({ id: p.id, raw });
    const isCaller = document.getElementById("call_" + p.id).checked;
    if (isCaller) caller = p.id;
  });

  // determine winner
  const scores = entries.map(e => ({ id: e.id, score: e.raw }));
  let winner = null;

  if (caller != null) {
    const callerEntry = scores.find(s => s.id === caller);
    const beaten = scores.filter(s => s.id !== caller && s.score <= callerEntry.score);

    if (beaten.length > 0) {
      const lowest = beaten.sort((a,b)=>a.score-b.score)[0];
      winner = lowest.id;
      callerEntry.score += ASSAF_PENALTY;
      const ce = entries.find(e => e.id === caller);
      ce.raw += ASSAF_PENALTY;
    } else {
      winner = caller;
    }
  } else {
    winner = scores.sort((a,b)=>a.score-b.score)[0].id;
  }

  // apply streak + scoring
  players.forEach(p => {
    const e = entries.find(x => x.id === p.id);
    if (p.id === winner) {
      p.streak++;
      if (p.streak >= 3) {
        e.raw += STREAK_PENALTY;
      }
    } else {
      p.streak = 0;
    }

    p.total += e.raw;

    // exact totals bonus
    if ([50,100,150,200].includes(p.total)) {
      p.total -= 50;
    }
  });

  rounds.push({ entries, caller });

  render();
}

function undo() {
  if (rounds.length === 0) return;

  const last = rounds.pop();

  // reverse effects
  last.entries.forEach(e => {
    const p = players.find(x => x.id === e.id);
    p.total -= e.raw;
  });

  players.forEach(p => p.streak = 0);

  render();
}

function render() {
  renderPlayerList();
  renderRoundInputs();
  renderScores();
  renderLog();
}

function renderPlayerList() {
  const div = document.getElementById("players");
  div.innerHTML = players.map(p => `<div>${p.name}</div>`).join("");
}

function renderRoundInputs() {
  const div = document.getElementById("roundInputs");
  div.innerHTML = players.map(p => `
    <div class="player-row">
      <div style="flex:1">${p.name}</div>
      <input id="score_${p.id}" type="number" placeholder="Score">
      <input id="call_${p.id}" class="yahnev-radio" type="radio" name="caller">
    </div>
  `).join("");
}

function renderScores() {
  const tbody = document.getElementById("scoreTable");
  tbody.innerHTML = players.map(p => `
    <tr>
      <td>${p.name}</td>
      <td>${p.total}</td>
      <td>${"ðŸ”¥".repeat(Math.min(p.streak,5))}${p.streak>5?" x"+p.streak:""}</td>
    </tr>
  `).join("");
}

function renderLog() {
  const log = document.getElementById("log");
  log.innerHTML = rounds.map((r,i) => {
    const lines = r.entries.map(e => {
      const p = players.find(x => x.id === e.id);
      return `â€¢ ${p.name}: +${e.raw}`;
    }).join("<br/>");

    return `<div class="log-item"><strong>Round ${i+1}</strong><br/>${lines}</div>`;
  }).join("");
}
</script>

</body>
</html>

